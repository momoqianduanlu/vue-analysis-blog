<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>合并配置 | vue源码解析</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="vue源码解析课程笔记 记录细节实现">
    <link rel="preload" href="/vue-analysis-blog/assets/css/0.styles.d07f82ba.css" as="style"><link rel="preload" href="/vue-analysis-blog/assets/js/app.6aeeb6df.js" as="script"><link rel="preload" href="/vue-analysis-blog/assets/js/2.8ac59259.js" as="script"><link rel="preload" href="/vue-analysis-blog/assets/js/30.e2e6df6c.js" as="script"><link rel="prefetch" href="/vue-analysis-blog/assets/js/10.20c9d7ce.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/11.e3ae312d.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/12.1e156bc6.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/13.131b32cb.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/14.f37a321f.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/15.01f4e820.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/16.bd0bfdcc.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/17.88bb3a26.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/18.92cd0497.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/19.e9845e4f.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/20.37c7e4d8.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/21.90eb88f7.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/22.676923d8.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/23.7db1f24c.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/24.1079b0d8.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/25.471c5dd4.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/26.d6a7543a.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/27.95265ee3.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/28.4d0ddea1.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/29.27c3d4e7.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/3.c2ba8fa6.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/31.81c0c28c.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/32.05c48121.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/33.464f3ea6.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/34.92b778a7.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/35.707ced33.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/36.67796c42.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/37.ad4edb1b.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/38.77ea592b.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/39.6a1b09ea.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/4.5390220c.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/40.476918aa.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/41.80c8bf8b.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/42.7cf6be04.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/43.7f59e355.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/44.83fd3377.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/45.13754e7e.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/46.17963f12.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/47.4581e28b.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/5.b31e05fb.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/6.3c8b0c72.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/7.3ba56037.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/8.56405d2d.js"><link rel="prefetch" href="/vue-analysis-blog/assets/js/9.56a1ac1f.js">
    <link rel="stylesheet" href="/vue-analysis-blog/assets/css/0.styles.d07f82ba.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vue-analysis-blog/" class="home-link router-link-active"><!----> <span class="site-name">vue源码解析</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>开始</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-analysis-blog/chapter1/" class="sidebar-link">Vue 源码目录设计</a></li><li><a href="/vue-analysis-blog/chapter1/Vue.js 源码构建.html" class="sidebar-link">Vue.js源码构建</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>从入口到Vue的构造函数</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-analysis-blog/chapter2/" class="sidebar-link">从入口开始</a></li><li><a href="/vue-analysis-blog/chapter2/initGlobalApi.html" class="sidebar-link">initGlobalApi</a></li><li><a href="/vue-analysis-blog/chapter2/initMixin.html" class="sidebar-link">initMixin</a></li><li><a href="/vue-analysis-blog/chapter2/stateMixin.html" class="sidebar-link">stateMixin</a></li><li><a href="/vue-analysis-blog/chapter2/eventsMixin.html" class="sidebar-link">eventsMixin</a></li><li><a href="/vue-analysis-blog/chapter2/lifeCycleMixin.html" class="sidebar-link">lifeCycleMixin</a></li><li><a href="/vue-analysis-blog/chapter2/renderMixin.html" class="sidebar-link">renderMixin</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>数据驱动</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-analysis-blog/chapter3/" class="sidebar-link">数据驱动</a></li><li><a href="/vue-analysis-blog/chapter3/new Vue 发生了什么.html" class="sidebar-link">new Vue 发生了什么(initState)</a></li><li><a href="/vue-analysis-blog/chapter3/$mount.html" class="sidebar-link">Vue 实例挂载的实现($mount)</a></li><li><a href="/vue-analysis-blog/chapter3/render.html" class="sidebar-link">render和renderProxy</a></li><li><a href="/vue-analysis-blog/chapter3/createElement.html" class="sidebar-link">createElement</a></li><li><a href="/vue-analysis-blog/chapter3/update.html" class="sidebar-link">update</a></li><li><a href="/vue-analysis-blog/chapter3/第二章总结.html" class="sidebar-link">Vue是如何将数据渲染到dom的</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>组件化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-analysis-blog/chapter4/" aria-current="page" class="sidebar-link">组件化</a></li><li><a href="/vue-analysis-blog/chapter4/createComponent.html" class="sidebar-link">createComponent</a></li><li><a href="/vue-analysis-blog/chapter4/patch.html" class="sidebar-link">patch</a></li><li><a href="/vue-analysis-blog/chapter4/组件生成vnode到patch.html" class="sidebar-link">组件生成的vnode如何patch成真实dom</a></li><li><a href="/vue-analysis-blog/chapter4/合并配置.html" class="active sidebar-link">合并配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue-analysis-blog/chapter4/合并配置.html#demo举例" class="sidebar-link">demo举例</a></li><li class="sidebar-sub-header"><a href="/vue-analysis-blog/chapter4/合并配置.html#vue-mixin合并options" class="sidebar-link">Vue.mixin合并options</a></li><li class="sidebar-sub-header"><a href="/vue-analysis-blog/chapter4/合并配置.html#mergeoptions函数分析" class="sidebar-link">mergeOptions函数分析</a></li><li class="sidebar-sub-header"><a href="/vue-analysis-blog/chapter4/合并配置.html#new-vue初始化合并options" class="sidebar-link">new Vue初始化合并options</a></li><li class="sidebar-sub-header"><a href="/vue-analysis-blog/chapter4/合并配置.html#组件extend时合并options" class="sidebar-link">组件extend时合并options</a></li></ul></li><li><a href="/vue-analysis-blog/chapter4/生命周期.html" class="sidebar-link">生命周期</a></li><li><a href="/vue-analysis-blog/chapter4/组件注册.html" class="sidebar-link">组件注册</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>虚拟DOM和VNode</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-analysis-blog/chapter5/" class="sidebar-link">虚拟DOM</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>深入响应式原理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-analysis-blog/chapter6/" class="sidebar-link">响应式对象</a></li><li><a href="/vue-analysis-blog/chapter6/依赖收集.html" class="sidebar-link">依赖收集</a></li><li><a href="/vue-analysis-blog/chapter6/派发更新.html" class="sidebar-link">派发更新</a></li><li><a href="/vue-analysis-blog/chapter6/nextTick.html" class="sidebar-link">nextTick</a></li><li><a href="/vue-analysis-blog/chapter6/变化侦测注意事项.html" class="sidebar-link">变化侦测注意事项</a></li><li><a href="/vue-analysis-blog/chapter6/变化侦测API实现.html" class="sidebar-link">变化侦测API实现</a></li><li><a href="/vue-analysis-blog/chapter6/computed处理.html" class="sidebar-link">computed处理</a></li><li><a href="/vue-analysis-blog/chapter6/watch处理.html" class="sidebar-link">Watch处理</a></li><li><a href="/vue-analysis-blog/chapter6/props处理.html" class="sidebar-link">props处理</a></li><li><a href="/vue-analysis-blog/chapter6/method处理.html" class="sidebar-link">method处理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>编译原理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-analysis-blog/chapter7/" class="sidebar-link">介绍</a></li><li><a href="/vue-analysis-blog/chapter7/compileToFunctions.html" class="sidebar-link">compolieToFunctions</a></li><li><a href="/vue-analysis-blog/chapter7/parse模板解析.html" class="sidebar-link">parse模板解析</a></li><li><a href="/vue-analysis-blog/chapter7/optimize优化.html" class="sidebar-link">optimize优化</a></li><li><a href="/vue-analysis-blog/chapter7/codegen代码生成.html" class="sidebar-link">codegen代码生成</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>扩展</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-analysis-blog/chapter8/" class="sidebar-link">扩展</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="合并配置"><a href="#合并配置" class="header-anchor">#</a> 合并配置</h1> <p>通过之前章节的源码分析我们知道，<code>new Vue</code> 的过程通常有 2 种场景，一种是外部我们的代码主动调用 <code>new Vue(options)</code> 的方式实例化一个 Vue 对象；另一种是我们上一节分析的组件<code>patch</code>过程中内部通过 <code>new Vue(options)</code> 实例化子组件。</p> <p>无论哪种场景，都会执行实例的 <code>_init(options)</code> 方法，它首先会执行一个 <code>merge options</code> 的逻辑，相关的代码在 <code>src/core/instance/init.js</code> 中：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_init</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">options<span class="token operator">?</span><span class="token operator">:</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// merge options</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>_isComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// optimize internal component instantiation</span>
    <span class="token comment">// since dynamic options merging is pretty slow, and none of the</span>
    <span class="token comment">// internal component options needs special treatment.</span>
    <span class="token function">initInternalComponent</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span>$options <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>
      <span class="token function">resolveConstructorOptions</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token punctuation">,</span>
      options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      vm
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

</code></pre></div><p>在合并配置的场景中<code>Vue</code>也是做了区分，一种是组件配置的合并，另一种是<code>new Vue</code>初始化时配置的合并，</p> <p>不同场景对于 <code>options</code> 的合并逻辑是不一样的，并且传入的 <code>options</code> 值也有非常大的不同，</p> <h2 id="demo举例"><a href="#demo举例" class="header-anchor">#</a> demo举例</h2> <p>在这个demo中我们很明确的指明了了我们要分析<code>mergeOptions</code>合并的场景，但是在这里要注意一下<code>Vue.mixin</code>的合并，</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">let</span> childComp <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'childComp'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token string">'&lt;div&gt;{{msg}}&lt;/div&gt;'</span><span class="token punctuation">,</span>
  <span class="token function">created</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child created'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child mounted'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      msg<span class="token operator">:</span> <span class="token string">'Hello Vue'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">created</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent created'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'app'</span><span class="token punctuation">,</span>
  el<span class="token operator">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>
  <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token parameter">h</span> <span class="token operator">=&gt;</span> <span class="token function">h</span><span class="token punctuation">(</span>childComp<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="vue-mixin合并options"><a href="#vue-mixin合并options" class="header-anchor">#</a> Vue.mixin合并options</h2> <p>当我们开始进行源码调试的时候，首先会执行<code>Vue.mixin</code>，先执行<code>Vue.mixin</code>的原因是因为我们在demo中把他在<code>new Vue</code>之前调用了。</p> <p>Vue.mixin的代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> mergeOptions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util/index'</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initMixin</span> <span class="token punctuation">(</span><span class="token parameter">Vue<span class="token operator">:</span> GlobalAPI</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Vue<span class="token punctuation">.</span><span class="token function-variable function">mixin</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">mixin<span class="token operator">:</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">,</span> mixin<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>他的执行也很简单，通过调用<code>mergeOptions</code>函数来合并配置，此时<code>this.options = Vue.options(全局options)</code> 参数<code>mixin</code>就是传入的<code>created</code>钩子函数。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// this.options</span>
components<span class="token operator">:</span> <span class="token punctuation">{</span>KeepAlive<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> Transition<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> TransitionGroup<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">}</span>
directives<span class="token operator">:</span> <span class="token punctuation">{</span>model<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> show<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">}</span>
filters<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
_base<span class="token operator">:</span> ƒ <span class="token function">Vue</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>

<span class="token comment">// mixin</span>
created<span class="token operator">:</span> ƒ <span class="token function">created</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>那么<code>Vue.options</code>是什么？别急，下面我们会分析到。</p> <p>最终当我们执行完<code>mergeOptions</code>以后<code>Vue.options</code>这个配置对象会挂载<code>created</code>这个配置。</p> <h2 id="mergeoptions函数分析"><a href="#mergeoptions函数分析" class="header-anchor">#</a> mergeOptions函数分析</h2> <p>其实，在调用<code>mergeOptions</code>配置的过程中，有一段逻辑是非常有意思的，这段代码可以算作合并配置的核心，下面我们来进行逐行分析</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">mergeOptions</span> <span class="token punctuation">(</span>
  <span class="token parameter">parent<span class="token operator">:</span> Object<span class="token punctuation">,</span>
  child<span class="token operator">:</span> Object<span class="token punctuation">,</span>
  vm<span class="token operator">?</span><span class="token operator">:</span> Component</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Object <span class="token punctuation">{</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">let</span> key
  <span class="token keyword">for</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">mergeField</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasOwn</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">mergeField</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">mergeField</span> <span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> strat <span class="token operator">=</span> strats<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">||</span> defaultStrat
    options<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">strat</span><span class="token punctuation">(</span>parent<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> child<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> vm<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> options
<span class="token punctuation">}</span>
</code></pre></div><p><code>mergeOptions</code>函数最终返回的是一个<code>options</code>对象，他接受三个参数，<code>parent, child, vm</code>，对于<code>Vue.mixin</code>调用的<code>mergeOptions</code>中传的参数就是<code>parent = Vue.options</code>，<code>child = { created: function }</code>， <code>vm = undefined</code>。</p> <p>那配置是怎么合并的呢？</p> <p>在代码中不管是<code>parent</code>or <code>child</code>他都是一个对象，然后会对这两个对象做循环遍历，在遍历的过程中会调用<code>mergeField</code>函数，这个函数的实现非常有意思，</p> <p>首先：<code>mergeField</code>接收一个<code>key</code>，</p> <p>然后：<code>strats</code>是一个对象，Vue之所以能够灵活地合并很多配置项与<code>strats</code> 这个对象有很大的关系，</p> <p><code>flow</code>规定的是<code>strats</code>这个对象的<code>key</code>是一个字符串，<code>value</code>是一个函数，</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> strats <span class="token operator">=</span> config<span class="token punctuation">.</span>optionMergeStrategies
</code></pre></div><p>举个列子：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">LIFECYCLE_HOOKS</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">hook</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  strats<span class="token punctuation">[</span>hook<span class="token punctuation">]</span> <span class="token operator">=</span> mergeHook<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">mergeHook</span> <span class="token punctuation">(</span>
  <span class="token parameter">parentVal<span class="token operator">:</span> <span class="token operator">?</span>Array<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  childVal<span class="token operator">:</span> <span class="token operator">?</span>Function <span class="token operator">|</span> <span class="token operator">?</span>Array<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token operator">?</span>Array<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> childVal
    <span class="token operator">?</span> parentVal
      <span class="token operator">?</span> parentVal<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>childVal<span class="token punctuation">)</span>
      <span class="token operator">:</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>childVal<span class="token punctuation">)</span>
        <span class="token operator">?</span> childVal
        <span class="token operator">:</span> <span class="token punctuation">[</span>childVal<span class="token punctuation">]</span>
    <span class="token operator">:</span> parentVal
<span class="token punctuation">}</span>
</code></pre></div><p>此时在<code>Vue.mixin</code>当前场景下面，<code>parentVal</code>是空，<code>childVal</code>是<code>childVal = ƒ created()</code>，最终执行完<code>mergeHook</code>返回的是一个数组<code>res = [f]</code>。</p> <p><code>LIFECYCLE_HOOKS</code>定义的是生命周期的字符串<code>key</code>。</p> <p>从举的列子中可以看到，<code>strat</code>最终得到的是一个函数，也就是<code>mergeHook</code>，当调用<code>mergeHook</code>的时候那么</p> <p><code>options[key] = [created]</code>。</p> <p>这时已经完成了<code>Vue.mixin</code>的合并，将<code>created</code>钩子函数混入到<code>Vue.options</code>上面。</p> <div class="language-js extra-class"><pre class="language-js"><code>components<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
created<span class="token operator">:</span> <span class="token punctuation">[</span>ƒ<span class="token punctuation">]</span>
directives<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
filters<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
_base<span class="token operator">:</span> ƒ <span class="token function">Vue</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
</code></pre></div><h2 id="new-vue初始化合并options"><a href="#new-vue初始化合并options" class="header-anchor">#</a> new Vue初始化合并options</h2> <p>当执行 <code>new Vue</code> 的时候，在执行 <code>this._init(options)</code> 的时候，就会执行如下逻辑去合并 <code>options</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code>vm<span class="token punctuation">.</span>$options <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>
  <span class="token function">resolveConstructorOptions</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token punctuation">,</span>
  options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  vm
<span class="token punctuation">)</span>
</code></pre></div><p>这里通过调用 <code>mergeOptions</code> 方法来合并，它实际上就是把 <code>resolveConstructorOptions(vm.constructor)</code> 的返回值和<code>new Vue</code>传入的 <code>options</code> 做合并，<code>resolveConstructorOptions</code> 的实现先不考虑，在我们这个场景下，它还是简单返回 <code>vm.constructor.options</code>，相当于 <code>Vue.options</code>，那么这个值又是什么呢？其实在 <code>initGlobalAPI(Vue)</code> 的时候定义了这个值，</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initGlobalAPI</span> <span class="token punctuation">(</span><span class="token parameter">Vue<span class="token operator">:</span> GlobalAPI</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  Vue<span class="token punctuation">.</span>options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token constant">ASSET_TYPES</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">type</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    Vue<span class="token punctuation">.</span>options<span class="token punctuation">[</span>type <span class="token operator">+</span> <span class="token string">'s'</span><span class="token punctuation">]</span> <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// this is used to identify the &quot;base&quot; constructor to extend all plain-object</span>
  <span class="token comment">// components with in Weex's multi-instance scenarios.</span>
  Vue<span class="token punctuation">.</span>options<span class="token punctuation">.</span>_base <span class="token operator">=</span> Vue

  <span class="token function">extend</span><span class="token punctuation">(</span>Vue<span class="token punctuation">.</span>options<span class="token punctuation">.</span>components<span class="token punctuation">,</span> builtInComponents<span class="token punctuation">)</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>首先通过 <code>Vue.options = Object.create(null)</code> 创建一个空对象，然后遍历 <code>ASSET_TYPES</code>，<code>ASSET_TYPES</code> 的定义在 <code>src/shared/constants.js</code> 中：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">ASSET_TYPES</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'component'</span><span class="token punctuation">,</span>
  <span class="token string">'directive'</span><span class="token punctuation">,</span>
  <span class="token string">'filter'</span>
<span class="token punctuation">]</span>
</code></pre></div><p>所以上面遍历 <code>ASSET_TYPES</code> 后的代码相当于：</p> <div class="language-js extra-class"><pre class="language-js"><code>Vue<span class="token punctuation">.</span>options<span class="token punctuation">.</span>components <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
Vue<span class="token punctuation">.</span>options<span class="token punctuation">.</span>directives <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
Vue<span class="token punctuation">.</span>options<span class="token punctuation">.</span>filters <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>那么回到 <code>mergeOptions</code> 这个函数，它的定义在 <code>src/core/util/options.js</code> 中：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 参数：
 		parent:
 			components: {}
			created: [ƒ] // Vue.mixin混入的
			directives: {}
			filters: {}
			_base: ƒ Vue(options)
		child:
			el: &quot;#app&quot;
			name: &quot;app&quot;
			render: ƒ render(h)
 */</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">mergeOptions</span> <span class="token punctuation">(</span>
  <span class="token parameter">parent<span class="token operator">:</span> Object<span class="token punctuation">,</span>
  child<span class="token operator">:</span> Object<span class="token punctuation">,</span>
  vm<span class="token operator">?</span><span class="token operator">:</span> Component</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Object <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">checkComponents</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> child <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    child <span class="token operator">=</span> child<span class="token punctuation">.</span>options
  <span class="token punctuation">}</span>

  <span class="token function">normalizeProps</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
  <span class="token function">normalizeInject</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
  <span class="token function">normalizeDirectives</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
  <span class="token keyword">const</span> extendsFrom <span class="token operator">=</span> child<span class="token punctuation">.</span>extends
  <span class="token class-name">if</span> <span class="token punctuation">(</span>extendsFrom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    parent <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> extendsFrom<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>mixins<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> child<span class="token punctuation">.</span>mixins<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      parent <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> child<span class="token punctuation">.</span>mixins<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">let</span> key
  <span class="token keyword">for</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">mergeField</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasOwn</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">mergeField</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">mergeField</span> <span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> strat <span class="token operator">=</span> strats<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">||</span> defaultStrat
    options<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">strat</span><span class="token punctuation">(</span>parent<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> child<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> vm<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> options
<span class="token punctuation">}</span>
</code></pre></div><p><code>mergeOptions</code> 主要功能就是把 <code>parent</code> 和 <code>child</code> 这两个对象根据一些合并策略，合并成一个新对象并返回。比较核心的几步，先递归把 <code>extends</code> 和 <code>mixins</code> 合并到 <code>parent</code> 上，然后遍历 <code>parent</code>，调用 <code>mergeField</code>，然后再遍历 <code>child</code>，如果 <code>key</code> 不在 <code>parent</code> 的自身属性上，则调用 <code>mergeField</code>。</p> <p>这里有意思的是 <code>mergeField</code> 函数，它对不同的 <code>key</code> 有着不同的合并策略。举例来说，对于生命周期函数，它的合并策略是这样的：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">mergeHook</span> <span class="token punctuation">(</span>
  <span class="token parameter">parentVal<span class="token operator">:</span> <span class="token operator">?</span>Array<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  childVal<span class="token operator">:</span> <span class="token operator">?</span>Function <span class="token operator">|</span> <span class="token operator">?</span>Array<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token operator">?</span>Array<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> childVal
    <span class="token operator">?</span> parentVal
      <span class="token operator">?</span> parentVal<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>childVal<span class="token punctuation">)</span>
      <span class="token operator">:</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>childVal<span class="token punctuation">)</span>
        <span class="token operator">?</span> childVal
        <span class="token operator">:</span> <span class="token punctuation">[</span>childVal<span class="token punctuation">]</span>
    <span class="token operator">:</span> parentVal
<span class="token punctuation">}</span>

<span class="token constant">LIFECYCLE_HOOKS</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">hook</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  strats<span class="token punctuation">[</span>hook<span class="token punctuation">]</span> <span class="token operator">=</span> mergeHook
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这其中的 <code>LIFECYCLE_HOOKS</code> 的定义在 <code>src/shared/constants.js</code> 中：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">LIFECYCLE_HOOKS</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'beforeCreate'</span><span class="token punctuation">,</span>
  <span class="token string">'created'</span><span class="token punctuation">,</span>
  <span class="token string">'beforeMount'</span><span class="token punctuation">,</span>
  <span class="token string">'mounted'</span><span class="token punctuation">,</span>
  <span class="token string">'beforeUpdate'</span><span class="token punctuation">,</span>
  <span class="token string">'updated'</span><span class="token punctuation">,</span>
  <span class="token string">'beforeDestroy'</span><span class="token punctuation">,</span>
  <span class="token string">'destroyed'</span><span class="token punctuation">,</span>
  <span class="token string">'activated'</span><span class="token punctuation">,</span>
  <span class="token string">'deactivated'</span><span class="token punctuation">,</span>
  <span class="token string">'errorCaptured'</span>
<span class="token punctuation">]</span>
</code></pre></div><p>这里定义了 Vue.js 所有的钩子函数名称，所以对于钩子函数，他们的合并策略都是 <code>mergeHook</code> 函数。这个函数的实现也非常有意思，用了一个多层 3 元运算符，逻辑就是如果不存在 <code>childVal</code> ，就返回 <code>parentVal</code>；否则再判断是否存在 <code>parentVal</code>，如果存在就把 <code>childVal</code> 添加到 <code>parentVal</code>后返回新数组；否则返回 <code>childVal</code> 的数组。所以回到 <code>mergeOptions</code> 函数，一旦 <code>parent</code> 和 <code>child</code> 都定义了相同的钩子函数，那么它们会把 2 个钩子函数合并成一个数组。</p> <p>通过执行 <code>mergeField</code> 函数，把合并后的结果保存到 <code>options</code> 对象中，最终返回它。</p> <p>因此，在我们当前这个 case 下，执行完如下合并后：</p> <div class="language-js extra-class"><pre class="language-js"><code>vm<span class="token punctuation">.</span>$options <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>
  <span class="token function">resolveConstructorOptions</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token punctuation">,</span>
  options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  vm
<span class="token punctuation">)</span>
</code></pre></div><p><code>vm.$options</code> 的值差不多是如下这样：</p> <div class="language-js extra-class"><pre class="language-js"><code>vm<span class="token punctuation">.</span>$options <span class="token operator">=</span> <span class="token punctuation">{</span>
  components<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  created<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">function</span> <span class="token function">created</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent created'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  directives<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  filters<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">_base</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">Vue</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  el<span class="token operator">:</span> <span class="token string">&quot;#app&quot;</span><span class="token punctuation">,</span>
  <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">h</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="组件extend时合并options"><a href="#组件extend时合并options" class="header-anchor">#</a> 组件extend时合并options</h2> <p>由于组件的构造函数是通过 <code>Vue.extend</code> 继承自 <code>Vue</code> 的，先回顾一下这个过程，代码定义在 <code>src/core/global-api/extend.js</code> 中。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 参数：
 		Super.options：
 			components: {}
      created: [ƒ]
      directives: {}
      filters: {}
      _base: ƒ Vue(options)
 		extendOptions：
      created: ƒ created()
      data: ƒ data()
      mounted: ƒ mounted()
      name: &quot;childComp&quot;
      template: &quot;&lt;div&gt;{{msg}}&lt;/div&gt;&quot;
 */</span>
Vue<span class="token punctuation">.</span><span class="token function-variable function">extend</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">extendOptions<span class="token operator">:</span> Object</span><span class="token punctuation">)</span><span class="token operator">:</span> Function <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  Sub<span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>
    Super<span class="token punctuation">.</span>options<span class="token punctuation">,</span>
    extendOptions
  <span class="token punctuation">)</span>

  <span class="token comment">// ...</span>
  <span class="token comment">// keep a reference to the super options at extension time.</span>
  <span class="token comment">// later at instantiation we can check if Super's options have</span>
  <span class="token comment">// been updated.</span>
  Sub<span class="token punctuation">.</span>superOptions <span class="token operator">=</span> Super<span class="token punctuation">.</span>options
  Sub<span class="token punctuation">.</span>extendOptions <span class="token operator">=</span> extendOptions
  Sub<span class="token punctuation">.</span>sealedOptions <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> Sub<span class="token punctuation">.</span>options<span class="token punctuation">)</span>

  <span class="token comment">// ...</span>
  <span class="token keyword">return</span> Sub
<span class="token punctuation">}</span>
</code></pre></div><p>我们只保留关键逻辑，这里的 <code>extendOptions</code> 对应的就是前面定义的组件对象，它会和 <code>Vue.options</code> 合并到 <code>Sub.opitons</code> 中，在子组件构造函数中先完成<code>extendOptions</code> 与 <code>Vue.options</code> 的合并后，接下来会在子组件实例化的过程中把 <code>Sub.options</code> 与 <code>parent</code>，<code>parentVnode</code> 做合并。</p> <p>接下来我们再回忆一下子组件的初始化过程，代码定义在 <code>src/core/vdom/create-component.js</code>中：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createComponentInstanceForVnode</span> <span class="token punctuation">(</span>
  vnode<span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token comment">// we know it's MountedComponentVNode but flow doesn't</span>
  parent<span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token comment">// activeInstance in lifecycle state</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Component <span class="token punctuation">{</span>
  <span class="token keyword">const</span> options<span class="token operator">:</span> InternalComponentOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
    _isComponent<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    _parentVnode<span class="token operator">:</span> vnode<span class="token punctuation">,</span>
    parent
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">vnode<span class="token punctuation">.</span>componentOptions<span class="token punctuation">.</span>Ctor</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里的 <code>vnode.componentOptions.Ctor</code> 就是指向 <code>Vue.extend</code> 的返回值 <code>Sub</code>， 所以 执行 <code>new vnode.componentOptions.Ctor(options)</code> 接着执行 <code>this._init(options)</code>，因为 <code>options._isComponent</code> 为 true，那么合并 <code>options</code> 的过程走到了 <code>initInternalComponent(vm, options)</code> 逻辑。先来看一下它的代码实现，在 <code>src/core/instance/init.js</code> 中：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initInternalComponent</span> <span class="token punctuation">(</span><span class="token parameter">vm<span class="token operator">:</span> Component<span class="token punctuation">,</span> options<span class="token operator">:</span> InternalComponentOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> opts <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>options<span class="token punctuation">)</span>
  <span class="token comment">// doing this because it's faster than dynamic enumeration.</span>
  <span class="token keyword">const</span> parentVnode <span class="token operator">=</span> options<span class="token punctuation">.</span>_parentVnode
  opts<span class="token punctuation">.</span>parent <span class="token operator">=</span> options<span class="token punctuation">.</span>parent
  opts<span class="token punctuation">.</span>_parentVnode <span class="token operator">=</span> parentVnode

  <span class="token keyword">const</span> vnodeComponentOptions <span class="token operator">=</span> parentVnode<span class="token punctuation">.</span>componentOptions
  opts<span class="token punctuation">.</span>propsData <span class="token operator">=</span> vnodeComponentOptions<span class="token punctuation">.</span>propsData
  opts<span class="token punctuation">.</span>_parentListeners <span class="token operator">=</span> vnodeComponentOptions<span class="token punctuation">.</span>listeners
  opts<span class="token punctuation">.</span>_renderChildren <span class="token operator">=</span> vnodeComponentOptions<span class="token punctuation">.</span>children
  opts<span class="token punctuation">.</span>_componentTag <span class="token operator">=</span> vnodeComponentOptions<span class="token punctuation">.</span>tag

  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>render<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    opts<span class="token punctuation">.</span>render <span class="token operator">=</span> options<span class="token punctuation">.</span>render
    opts<span class="token punctuation">.</span>staticRenderFns <span class="token operator">=</span> options<span class="token punctuation">.</span>staticRenderFns
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Sub.options</span>
components<span class="token operator">:</span> <span class="token punctuation">{</span>childComp<span class="token operator">:</span> ƒ<span class="token punctuation">}</span>
created<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>ƒ<span class="token punctuation">,</span> ƒ<span class="token punctuation">]</span>
data<span class="token operator">:</span> ƒ <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
directives<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
filters<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
mounted<span class="token operator">:</span> <span class="token punctuation">[</span>ƒ<span class="token punctuation">]</span>
name<span class="token operator">:</span> <span class="token string">&quot;childComp&quot;</span>
template<span class="token operator">:</span> <span class="token string">&quot;&lt;div&gt;{{msg}}&lt;/div&gt;&quot;</span>
_Ctor<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token operator">:</span> ƒ<span class="token punctuation">}</span>
_base<span class="token operator">:</span> ƒ <span class="token function">Vue</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
</code></pre></div><p><code>initInternalComponent</code> 方法首先执行 <code>const opts = vm.$options = Object.create(vm.constructor.options)</code>，这里的 <code>vm.constructor</code> 就是子组件的构造函数 <code>Sub</code>，相当于 <code>vm.$options = Object.create(Sub.options)</code>。</p> <p>接着又把实例化子组件传入的子组件父 VNode 实例 <code>parentVnode</code>、子组件的父 Vue 实例 <code>parent</code> 保存到 <code>vm.$options</code> 中，另外还保留了 <code>parentVnode</code> 配置中的如 <code>propsData</code> 等其它的属性。</p> <p>这么看来，<code>initInternalComponent</code> 只是做了简单一层对象赋值，并不涉及到递归、合并策略等复杂逻辑，所以组件的合并速度会更快。</p> <p>因此，在我们当前这个 case 下，执行完如下合并后：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">initInternalComponent</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
</code></pre></div><p><code>vm.$options</code> 的值差不多是如下这样：</p> <div class="language-js extra-class"><pre class="language-js"><code>vm<span class="token punctuation">.</span>$options <span class="token operator">=</span> <span class="token punctuation">{</span>
  parent<span class="token operator">:</span> Vue <span class="token comment">/*父Vue实例*/</span><span class="token punctuation">,</span>
  propsData<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  _componentTag<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  _parentVnode<span class="token operator">:</span> VNode <span class="token comment">/*父VNode实例*/</span><span class="token punctuation">,</span>
  _renderChildren<span class="token operator">:</span><span class="token keyword">undefined</span><span class="token punctuation">,</span>
  __proto__<span class="token operator">:</span> <span class="token punctuation">{</span>
    components<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    directives<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    filters<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">_base</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">Vue</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//...</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    _Ctor<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    created<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token keyword">function</span> <span class="token function">created</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent created'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">created</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child created'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    mounted<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token keyword">function</span> <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child mounted'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token punctuation">{</span>
         msg<span class="token operator">:</span> <span class="token string">'Hello Vue'</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    template<span class="token operator">:</span> <span class="token string">'&lt;div&gt;{{msg}}&lt;/div&gt;'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/vue-analysis-blog/chapter4/组件生成vnode到patch.html" class="prev">
        组件生成的vnode如何patch成真实dom
      </a></span> <span class="next"><a href="/vue-analysis-blog/chapter4/生命周期.html">
        生命周期
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/vue-analysis-blog/assets/js/app.6aeeb6df.js" defer></script><script src="/vue-analysis-blog/assets/js/2.8ac59259.js" defer></script><script src="/vue-analysis-blog/assets/js/30.e2e6df6c.js" defer></script>
  </body>
</html>
